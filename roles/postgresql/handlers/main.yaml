- name: PostgreSQL Setup Complete
  block:
    - name: Wait for PostgreSQL to accept connections
      ansible.builtin.wait_for:
        host: 127.0.0.1
        port: 5432
        delay: 5
        timeout: 180
        state: started

    - name: Create database if it does not exist
      community.postgresql.postgresql_db:
        name: "{{ db_name }}"
        state: present
        login_user: "{{ postgres_user }}"
        login_password: "{{ password }}"
        login_host: 127.0.0.1
        login_port: 5432

    - name: Create task table
      community.postgresql.postgresql_query:
        db: "{{ db_name }}"
        query: |
          CREATE TABLE IF NOT EXISTS test_table (
            id bigserial primary key,
            task text
          );
        login_user: "{{ postgres_user }}"
        login_password: "{{ password }}"
        login_host: 127.0.0.1
        login_port: 5432
